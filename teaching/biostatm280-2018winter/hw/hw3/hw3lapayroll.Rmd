---
title: "Biostat M280 Homework 3"
subtitle: Due Mar 3 @ 11:59PM
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("tidyverse")
library("lubridate")
```

# LA City Employee Payroll

The `/home/m280-data/la_payroll/LA_City_Employee_Payroll.csv` file contains payroll information LA City employees in 2013-7. It is downloaded from [LA Open Data Portal](https://data.lacity.org/A-Well-Run-City/Parking-Citations/wjz9-h9np).
```{bash, eval = (Sys.info()[["sysname"]] == "Linux")}
ln -sf /home/m280-data/la_payroll/LA_City_Employee_Payroll.csv LA_City_Employee_Payroll.csv
```

The CSV file is about 95MB.
```{bash}
ls -l LA_City_Employee_Payroll.csv
```

How many rows?
```{bash}
wc -l < LA_City_Employee_Payroll.csv
```

First few lines:
```{bash}
head -5 LA_City_Employee_Payroll.csv
```

## Import data

We import the data as tibble using tidyverse:
```{r}
system.time({lapay <- read_csv("LA_City_Employee_Payroll.csv")})
```

## Fix column names

```{r}
names(lapay) <- str_replace_all(names(lapay), " ", "_")
lapay %>% print(width = Inf)
```

## Fix currency

```{r}
lapay <- lapay %>% 
  mutate(Projected_Annual_Salary = as.numeric(str_sub(Projected_Annual_Salary, 2, -1)))
lapay %>% print(width = Inf)
```

## Keep relevant columns

```{r}
lapay <- lapay %>%
  select(Row_ID, Year, Department_Title, Job_Class_Title, Projected_Annual_Salary)
lapay %>% print(width = Inf)
```

## Save as RDS

```{r}
lapay %>% write_rds("lapay.rds")
```

## Who earned most?

Range of years:
```{r}
range(lapay$Year)
lapay$Year %>% table()
```

```{r, echo = FALSE}
selectInput("year", "Which year?", choices = 2013:2017, selected = 2017)
numericInput("n", "How many?", 5)

renderTable({
  lapay %>%
    filter(Year == input$year) %>%
    arrange(desc(Projected_Annual_Salary)) %>%
    head(input$n) %>%
    select(Department_Title, Job_Class_Title, Projected_Annual_Salary)
})
```

## Which deparments earn most? 

```{r, echo = FALSE}
selectInput("year_dep", "Which year?", choices = 2013:2017, selected = 2017)
numericInput("n_dep", "How many departments?", 5)
radioButtons("method", "Mean or median?", choices = c("mean", "median"), selected = "median")

renderPlot({
  data <- lapay %>%
    filter(Year == input$year_dep) %>%
    group_by(Department_Title) %>%
    summarise(avg = mean(Projected_Annual_Salary), med = median(Projected_Annual_Salary))
  if (input$method == "mean") {
    data %>%
      arrange(desc(avg)) %>%
      head(input$n_dep) %>%
      ggplot() + 
        geom_col(aes(x = Department_Title, y = avg))
  } else if (input$method == "median") {
    data %>%
      arrange(desc(med)) %>%
      head(input$n_dep) %>%
      ggplot() + 
        geom_col(aes(x = Department_Title, y = med))
  }
})
```
